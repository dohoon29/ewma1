# EWMA 및 환경 센서 기반 이상 징후 탐지 시스템

## 1. 프로젝트 설명

이 프로젝트는 전력 사용량(W) 및 기타 환경 센서(온도, 조도 등) 데이터를 분석하여 비정상적인 패턴이나 위험한 상황(과전류, 스파이크 등)을 탐지하는 시스템입니다.

최신 버전은 `v3` 모델(`home_env_power_detector_v3.py`)을 사용합니다.

## 2. 요구 사항

- Python 3.x
- `pandas`, `numpy` 라이브러리

라이브러리가 설치되어 있지 않다면, 터미널에서 아래 명령어를 실행하여 설치해 주세요.
```bash
pip install pandas numpy
```

## 3. 주요 파일 설명

- **`home_env_power_detector_v3.py`**: 핵심 탐지 로직이 들어있는 메인 v3 모델 파일입니다.
- **`run_v3_test.py`**: v3 모델을 쉽게 실행하기 위한 스크립트입니다.
- **`ewma_baseline_ch01.json`**: 현재 학습된 베이스라인 모델 파일입니다.
- **`v3_anomalies_output.csv`**: 탐지된 이상 징후 이벤트가 저장되는 결과 파일입니다.

## 4. 데이터 파일 형식 (Data File Format)

탐지 모델은 특정 형식의 CSV 파일을 입력으로 받습니다.

### 4.1. 메인 데이터 (`input_csv`)

전력 및 실내 환경 데이터가 포함된 기본 입력 파일입니다.

#### 필수 컬럼
- **타임스탬프**: `timestamp`, `time`, `ts`, `datetime` 중 하나의 컬럼명.
- **전력 사용량 (W)**: `power_w`, `power`, `watts`, `w` 중 하나의 컬럼명.

#### 선택적 컬럼
- **실내 온도 (°C)**: `temp_c`, `room_temp_c`
- **상대 습도 (%)**: `rh`, `humidity`
- **조도 (lux)**: `lux`

#### 예시
```csv
timestamp,power_w,temp_c,rh,lux
2023-10-27T00:00:00,150.5,22.5,45.2,10.0
2023-10-27T00:00:02,151.0,22.5,45.3,10.0
...
```

### 4.2. 외부 날씨 데이터 (`weather_csv` - 선택 사항)

온도 기반 탐지를 위해 선택적으로 사용할 수 있는 외부 날씨 데이터 파일입니다. `run_batch` 함수 사용 시 `weather_csv` 인자에 파일 경로를 지정하여 사용합니다.

#### 필수 컬럼
- **타임스탬프**: `timestamp`, `time`, `ts`, `datetime` 중 하나.
- **외부 온도 (°C)**: `outside_temp_C`, `outdoor_temp_C`, `temp_out_C` 중 하나.

## 5. 이상 탐지 기준 (Anomaly Detection Logic)

탐지되는 이벤트의 종류와 기준은 다음과 같습니다. 모든 기준값은 `Config` 클래스에서 수정할 수 있습니다.

### 5.1. 전력 기반 탐지

- **`power_ewma_anomaly`**: 전력 사용량의 지수 가중 이동 평균(EWMA)을 크게 벗어나는 패턴이 일정 시간 이상 지속될 때 발생합니다. 평소와 다른 전력 사용 패턴을 탐지합니다.
- **`overcurrent_near_limit`**: 전력 사용량을 기반으로 계산된 전류(A)가 설정된 임계값(기본 30A)에 근접하거나 초과할 때 발생합니다. 과부하 위험을 경고합니다.
- **`short_spike_suspect`**: 짧은 순간에 전류가 급격하게 변하거나 매우 높은 수치로 치솟을 때 발생합니다. 전기 합선이나 기기 고장으로 인한 스파이크를 탐지합니다.

### 5.2. 온도 기반 탐지

실내외 온도 및 조도 데이터를 바탕으로 비정상적인 온열 환경을 탐지합니다. (관련 데이터가 모두 제공될 경우에만 동작)

- **여름철 (6-8월)**: 실내 온도가 실외보다 비정상적으로 높을 때 (`1°C` 이상 '경고', `3°C` 이상 '주의').
- **겨울철 (12-2월)**: 실내 온도가 실외보다 충분히 따뜻하지 않을 때 (온도 차 `5°C` 이하 '경고', `3°C` 이하 '주의').
- **재실 판단**: 조도(`lux`)가 특정 값 미만일 경우, 사람이 없는 것으로 간주하여 온도 관련 탐지를 수행하지 않습니다.

## 6. 사용 방법

`run_v3_test.py` 스크립트를 통해 탐지를 실행합니다.

1.  분석하고 싶은 데이터(CSV 파일)를 프로젝트 폴더에 넣습니다.
2.  `run_v3_test.py` 파일을 열어 아래 변수들을 자신의 환경에 맞게 수정합니다.
    - `INPUT_FILE`: 분석할 데이터 파일 이름으로 변경합니다. (예: `'my_new_data.csv'`)
    - `BASELINE_FILE`: 사용할 베이스라인 모델 파일 이름으로 변경합니다. (예: `'my_baseline.json'`)
    - `OUTPUT_FILE`: 결과가 저장될 파일 이름을 지정합니다.
3.  터미널에서 아래 명령어를 실행합니다.
    ```bash
    python run_v3_test.py
    ```
4.  탐지가 완료되면 지정한 `OUTPUT_FILE` 이름으로 결과 파일이 생성됩니다.

## 7. 결과 확인

탐지 결과는 `v3_anomalies_output.csv` (또는 `OUTPUT_FILE`로 지정한 파일)에 저장됩니다.

- **type**: 탐지된 이벤트의 종류 (`short_spike_suspect`, `overcurrent_near_limit` 등)
- **start**: 이벤트 시작 시간
- **end**: 이벤트 종료 시간
- **severity**: 심각도 (`warn` 또는 `alert`)
- **info_json**: 이벤트에 대한 상세 정보 (JSON 형식)
